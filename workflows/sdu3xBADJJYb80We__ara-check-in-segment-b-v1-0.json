{
  "id": "sdu3xBADJJYb80We",
  "name": "ARA | Check-in | Segment B | v1.0",
  "active": 0,
  "createdAt": "2025-12-19 07:41:31.050",
  "updatedAt": "2026-01-25 14:34:40.913",
  "nodes": [
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Current user from IF node\nconst user = $json;\n\n// 1. Determine name\nlet name = user.preferred_name || user.first_name || \"there\";\n\n// 2. Determine language (normalised)\nlet lang = (user.preferred_language || \"en\").toLowerCase();\n\n// 3. Map language -> template name (your approved templates)\nlet template;\nswitch (lang) {\n  case \"ms\":\n    template = \"ara_followup_02\";\n    break;\n  case \"id\":\n    template = \"ara_followup_02_id\";\n    break;\n  case \"ta\":\n    template = \"ara_followup_02_ta\";\n    break;\n  case \"zh\":\n    template = \"ara_followup_02_zh\";\n    break;\n  default:\n    template = \"ara_followup_02_en\";\n    break;\n}\n\n// 4. Return ONE item (because mode = Run Once for Each Item)\nreturn {\n  json: {\n    user_id: user.user_id || user.id || null,\n    telegram_id: user.telegram_id || null,\n    name,\n    lang,\n    template,\n    context: null, // will be filled later by Extract Context\n  },\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        0
      ],
      "id": "16ea08a7-0581-47b9-b106-67577dd55caa",
      "name": "Prepare Template Payload"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "conversations",
        "limit": 20,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{$json.user_id}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        224,
        96
      ],
      "id": "7eb28700-7a21-4040-9f5a-f7f7afd11a69",
      "name": "Get Last Topic Row"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        672,
        0
      ],
      "id": "9f643bae-a1d1-46cd-ac6b-d7e228d2f864",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// Extract Context (Human-grade, Segment B/C safe)\n// INPUT: conversation rows from \"Get Last Topic Row\"\n// OUTPUT: { context: <raw_topic_string> }\n\nconst rows = $input.all().map(i => i.json);\n\n// ---------------- Utilities ----------------\n\nfunction clean(text) {\n  if (text === null || text === undefined) return null;\n  const s = String(text).replace(/\\s+/g, ' ').trim();\n  return s || null;\n}\n\nfunction lower(text) {\n  const c = clean(text);\n  return c ? c.toLowerCase() : '';\n}\n\n// ---------------- Hard Filters ----------------\n\n// Very low-signal user messages\nconst BORING = new Set([\n  'hi','hello','hai','hey',\n  'ok','okay','k','kk',\n  'ya','ye','yep','yup',\n  'tq','tqsm','thanks','thank you',\n  'yes','no',\n  'ğŸ‘','ğŸ‘Œ','ğŸ™','ğŸ˜Š'\n]);\n\nfunction isGreetingOrNoise(l) {\n  if (!l) return true;\n  if (BORING.has(l)) return true;\n\n  const prefixes = [\n    'hi','hello','hai','hey',\n    'assalamualaikum','assalammualaikum','salam',\n    'good morning','good night',\n    'selamat pagi','selamat malam'\n  ];\n\n  return prefixes.some(p =>\n    l === p || l.startsWith(p + ' ') || l.startsWith(p + ',')\n  );\n}\n\nfunction isProfileOrMeta(l) {\n  return (\n    l.includes('call me') ||\n    l.includes('my name is') ||\n    l.includes('what is my name') ||\n    l.includes('language') ||\n    l.includes('timezone') ||\n    l.includes('kuala lumpur') ||\n    l.includes('welcome the user') ||\n    l.includes('thanks for contacting ara') ||\n    l.includes('nama saya ara') ||\n    l.includes('my name is ara')\n  );\n}\n\nfunction isSexual(l) {\n  return (\n    l.includes('sex') ||\n    l.includes('have sex') ||\n    l.includes('sleep with')\n  );\n}\n\nfunction isBadTopic(l) {\n  return (\n    !l ||\n    l.length <= 5 ||\n    l.startsWith('/') ||\n    isGreetingOrNoise(l) ||\n    isProfileOrMeta(l) ||\n    isSexual(l)\n  );\n}\n\n// ---------------- Main Logic ----------------\n\nif (rows.length === 0) {\n  return [{ json: { context: 'everything on your end' } }];\n}\n\n// Sort latest â†’ oldest\nrows.sort((a, b) => {\n  const ta = a.created_at ? new Date(a.created_at).getTime() : 0;\n  const tb = b.created_at ? new Date(b.created_at).getTime() : 0;\n  return tb - ta;\n});\n\n// PASS 1: Look for REAL user intent\nlet topic = null;\n\nfor (const r of rows) {\n  const type = lower(r.message_type);\n\n  // ğŸš« Never learn from proactive messages\n  if (type.startsWith('proactive_')) continue;\n\n  const msg = clean(r.user_message);\n  const l = lower(msg);\n\n  if (isBadTopic(l)) continue;\n\n  topic = msg;\n  break;\n}\n\n// PASS 2: Fallback to assistant response ONLY if meaningful\nif (!topic) {\n  for (const r of rows) {\n    const type = lower(r.message_type);\n    if (type.startsWith('proactive_')) continue;\n\n    const msg = clean(r.assistant_response);\n    const l = lower(msg);\n\n    if (isBadTopic(l)) continue;\n    if (msg.length > 200) continue;\n\n    topic = msg;\n    break;\n  }\n}\n\n// FINAL fallback\nif (!topic) topic = 'everything on your end';\n\nreturn [{ json: { context: topic } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        432,
        96
      ],
      "id": "b0e0c2fb-f6c1-4f22-a0cc-11589ced2510",
      "name": "Extract Context"
    },
    {
      "parameters": {
        "jsCode": "// 1. Base user/template data from Merge node + allow upstream overrides (Time Normaliser)\nconst base = { ...($node[\"Merge\"].json || {}), ...($json || {}) };\n\n\n// Try to find the full user record from Get Users by id or telegram_id\nconst allUsers = $items(\"Get Users\") || [];\nlet fullUser = null;\n\nfor (const item of allUsers) {\n  const u = item.json || {};\n\n  const matchById =\n    base.user_id && (u.id === base.user_id || u.user_id === base.user_id);\n\n  const matchByTelegram =\n    base.telegram_id && u.telegram_id === base.telegram_id;\n\n  if (matchById || matchByTelegram) {\n    fullUser = u;\n    break;\n  }\n}\n\n\n// Helper to clean candidate values\nconst clean = (v) => {\n  if (v === null || v === undefined) return null;\n  const s = String(v).trim();\n  if (!s) return null;\n\n  const lower = s.toLowerCase();\n  // Treat these as â€œno valueâ€\n  if (lower === 'null' || lower === 'undefined') return null;\n\n  return s;\n};\n\n// Name priority using full user record where available\nconst preferred = clean(fullUser?.preferred_name ?? base.preferred_name);\nconst first = clean(fullUser?.first_name ?? base.first_name);\nconst handle = clean(fullUser?.telegram_username ?? base.telegram_username);\nconst legacyName = clean(base.name);\n\nconst name = preferred || first || handle || legacyName || 'there';\n\n// Language priority: explicit lang -> preferred_language -> 'en'\nconst lang =\n  (clean(base.lang) || clean(fullUser?.preferred_language) || 'en').toLowerCase();\n\n\n// Original context handling\nconst rawContext = (base.context || '').toString();\n\n\n// 2. Get localized topic phrase (prefer upstream-normalised field)\nlet localizedTopic = (base.localized_topic || \"\").toString().trim();\n\n// Fallback: if not provided, read from OpenAI output (older flow)\nif (!localizedTopic) {\n  try {\n    const content = $json.output?.[0]?.content?.[0]?.text;\n    if (typeof content === \"string\" && content.trim()) {\n      localizedTopic = content.trim();\n    }\n  } catch (e) {}\n}\n\n\n// 3. Normalise / clean the topic phrase\nfunction normalizeTopic(topic, lang) {\n  if (!topic || typeof topic !== \"string\") return \"\";\n  let t = topic.trim();\n  if (!t) return \"\";\n\n  let lower = t.toLowerCase();\n\n  // Helper to strip a list of prefixes\n  const stripPrefixes = (current, prefixes) => {\n    let txt = current;\n    let low = txt.toLowerCase();\n    for (const p of prefixes) {\n      if (low.startsWith(p.toLowerCase())) {\n        txt = txt.slice(p.length).trim();\n        low = txt.toLowerCase();\n        break;\n      }\n    }\n    return txt;\n  };\n\n  if (lang === \"ms\") {\n    t = stripPrefixes(t, [\n      \"apa cerita pasal\",\n      \"apa cerita tentang\",\n    ]);\n    lower = t.toLowerCase();\n    if (lower.startsWith(\"pasal \")) t = t.slice(\"pasal \".length).trim();\n    if (lower.startsWith(\"tentang \")) t = t.slice(\"tentang \".length).trim();\n  }\n\n  if (lang === \"id\") {\n    t = stripPrefixes(t, [\n      \"gimana cerita tentang\",\n      \"gimana cerita soal\",\n    ]);\n    lower = t.toLowerCase();\n    if (lower.startsWith(\"tentang \")) t = t.slice(\"tentang \".length).trim();\n    if (lower.startsWith(\"soal \")) t = t.slice(\"soal \".length).trim();\n  }\n\n  if (lang === \"en\") {\n    t = stripPrefixes(t, [\n      \"howâ€™s everything going with\",\n      \"how's everything going with\",\n    ]);\n    lower = t.toLowerCase();\n    if (lower.startsWith(\"about \")) t = t.slice(\"about \".length).trim();\n  }\n\n  // You can add similar guards for 'ta' / 'zh' if needed later\n\n  return t.trim();\n}\n\nlocalizedTopic = normalizeTopic(localizedTopic, lang);\n\n// If empty after cleaning, fall back to a generic phrase\nif (!localizedTopic) {\n  if (lang === \"ms\") {\n    localizedTopic = \"keadaan di pihak awak\";\n  } else if (lang === \"id\") {\n    localizedTopic = \"keadaan di pihak kamu\";\n  } else if (lang === \"ta\") {\n    localizedTopic = \"à®‰à®™à¯à®• à®ªà®•à¯à®•à®®à¯ à®à®²à¯à®²à®¾à®®à¯\";\n  } else if (lang === \"zh\") {\n    localizedTopic = \"ä½ é‚£è¾¹çš„æƒ…å†µ\";\n  } else {\n    localizedTopic = \"everything on your side\";\n  }\n}\n\n// Optional: special-case for \"Feel like just chatting\"\nconst isJustChatting = rawContext.toLowerCase().includes(\"feel like just chatting\");\n\n// 4. Build body based on preferred language using your approved templates\nlet body;\n\nswitch (lang) {\n  case \"ms\":\n    if (isJustChatting) {\n      body = `Hi ${name}, saja tanya khabar.\n\nMasih rasa nak borak-borak macam hari tu? Kalau teringin nak sembang atau luah apa-apa, just reply je.\n\nSaya sentiasa ada untuk awak ğŸ˜Š`;\n    } else {\n      body = `Hi ${name}, saja tanya khabar.\n\nApa cerita pasal ${localizedTopic}? Harap semuanya okay. \n\nKalau ada apa-apa update, rasa nak luah apa-apa atau nak saya bantu apa-apa, just share je. \n\nSaya sentiasa ada untuk awak ğŸ˜Š`;\n    }\n    break;\n\n  case \"id\":\n    body = `Hi ${name}, cuma mau tanya kabar.\n\nGimana cerita tentang ${localizedTopic}? Semoga semuanya baik-baik saja.\n\nKalau ada update, mau curhat, atau butuh bantuan apa pun, tinggal bilang ya.\n\nAku selalu ada untuk kamu ğŸ˜Š`;\n    break;\n\n  case \"ta\":\n    body = `à®¹à¯ˆ ${name}, à®‰à®™à¯à®• à®¨à®²à®®à®¾ à®‡à®°à¯à®•à¯à®•à¯€à®™à¯à®•à®©à¯à®©à¯ à®¤à¯†à®°à®¿à®à¯à®šà®¿à®•à¯à®•à®¤à¯à®¤à®¾à®©à¯ à®•à¯‡à®Ÿà¯à®Ÿà¯‡à®©à¯.\n\n${localizedTopic} à®ªà®±à¯à®±à®¿à®¯ à®µà®¿à®·à®¯à®®à¯ à®à®ªà¯à®ªà®Ÿà®¿ à®‡à®°à¯à®•à¯à®•à¯? à®à®²à¯à®²à®¾à®®à¯ à®¨à®©à¯à®±à®¾à®• à®‡à®°à¯à®•à¯à®•à®Ÿà¯à®Ÿà¯à®®à¯.\n\nà®à®¤à®¾à®µà®¤à¯ à®ªà¯à®¤à¯à®ªà¯à®ªà®¿à®ªà¯à®ªà¯ à®‡à®°à¯à®¨à¯à®¤à®¾, à®®à®©à®šà®¿à®²à¯ à®à®¤à®¾à®µà®¤à¯ à®µà®šà¯à®šà®¿à®°à¯à®¨à¯à®¤à®¾, à®…à®²à¯à®²à®¤à¯ à®à®©à¯à®©à®¾à®² à®‰à®¤à®µà®¿ à®šà¯†à®¯à¯à®¯ à®µà¯‡à®£à¯à®Ÿà¯à®®à¯à®©à¯ à®¤à¯‹à®£à®¿à®©à®¾, à®šà¯Šà®²à¯à®²à®¿à®Ÿà¯à®Ÿà®¾à®²à¯‡ à®ªà¯‹à®¤à¯à®®à¯.\n\nà®¨à®¾à®©à¯ à®à®ªà¯à®ªà¯‹à®¤à¯à®®à¯ à®‰à®™à¯à®•à®³à¯à®•à¯à®•à¯ à®†à®¤à®°à®µà®¾à®• à®‡à®°à¯à®•à¯à®•à¯‡à®©à¯ ğŸ˜Š`;\n    break;\n\n  case \"zh\":\n    body = `å—¨ ${name}ï¼Œå°±æ˜¯æ¥é—®å€™ä¸€ä¸‹ä½ ã€‚\n\nå…³äº${localizedTopic}ï¼Œæœ€è¿‘æƒ…å†µæ€ä¹ˆæ ·ï¼Ÿå¸Œæœ›ä¸€åˆ‡é¡ºåˆ©ã€‚\n\nå¦‚æœæœ‰ä»»ä½•æ–°çš„è¿›å±•ã€å¿ƒäº‹ï¼Œæˆ–è€…éœ€è¦æˆ‘å¸®å¿™çš„åœ°æ–¹ï¼Œéšæ—¶è·Ÿæˆ‘è¯´ã€‚\n\næˆ‘ä¸€ç›´åœ¨è¿™å„¿æ”¯æŒä½  ğŸ˜Š`;\n    break;\n\n  default: // 'en' and others\n    if (isJustChatting) {\n      body = `Hi ${name}, just checking in ğŸ˜Š\n\nStill feel like chatting these days? If you ever want to vent, brainstorm, or just talk, you can always reply here.\n\nIâ€™m always here for you ğŸ˜Š`;\n    } else if (localizedTopic === \"everything on your side\") {\n      // Special case so sentence is natural\n      body = `Hi ${name}, just checking in.\n\nHowâ€™s everything going with your side? Hope all is well.\n\nIf you have any updates, want to share anything, or need help with something, just let me know.\n\nIâ€™m always here for you ğŸ˜Š`;\n    } else {\n      body = `Hi ${name}, just checking in.\n\nHowâ€™s everything going with ${localizedTopic}? Hope all is well.\n\nIf you have any updates, want to share anything, or need help with something, just let me know.\n\nIâ€™m always here for you ğŸ˜Š`;\n    }\n    break;\n}\n\n// 5. Return final payload: keep base fields, but override name, then add localized_topic + body\nreturn [\n  {\n    json: {\n      ...base,              // user_id, telegram_id, etc.\n      name,                 // <-- overrides base.name = 'there'\n      localized_topic: localizedTopic,\n      body,\n    },\n  },\n];\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1456,
        0
      ],
      "id": "deac2369-60c9-4df7-bbd3-42d5d9ed2ebf",
      "name": "Build WhatsApp Body",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4.1-mini-2025-04-14",
          "mode": "list",
          "cachedResultName": "GPT-4.1-MINI-2025-04-14"
        },
        "responses": {
          "values": [
            {
              "role": "system",
              "content": "=You are ARA, a multilingual assistant.\n\nYour job is to generate a SINGLE question fragment to be used as Twilio template variable {{2}}.\n\nThe Twilio template is FIXED as:\nâ€œHowâ€™s everything going with {{2}}? Hope all is well.â€\n\nSo your output MUST be grammatically correct when inserted there.\n\n====================================================================\nOUTPUT FORMAT (MANDATORY)\n====================================================================\n\nReturn ONE line only.\n\nThe line MUST follow this exact structure:\n\n<noun phrase>, <offer clause in question form>\n\nIMPORTANT:\n- Do NOT include any question marks.\n- Do NOT include full sentences (only the fragment).\n- Do NOT include line breaks.\n- Do NOT include quotation marks.\n- Do NOT include any surrounding phrases like:\n  â€œHowâ€™s everything going withâ€\n  â€œApa cerita pasalâ€\n  â€œGimana cerita tentangâ€\n  â€œå…³äºâ€\n\nTwilio will automatically add the final â€œ?â€ after {{2}}.\n\n====================================================================\nHARD GROUNDING RULE (CRITICAL â€” NO EXCEPTIONS)\n====================================================================\n\nYou MUST ground your output in the raw_topic.\n\nRule G1:\n- The <noun phrase> MUST contain 1â€“3 meaningful keywords copied from raw_topic\n  (names, project, task, call, meeting, reminder, draft, checklist, etc.).\n- You MUST NOT output generic phrases like â€œeverything on your sideâ€ unless raw_topic is truly empty or meaningless.\n\nRule G2:\n- If raw_topic contains a PERSON name (e.g., Ali), you MUST include that name in the noun phrase.\n- If raw_topic contains an ACTION (e.g., call, meeting, follow up), you MUST include that action.\n\nOnly use the fallback â€œeverything on your sideâ€ if raw_topic is:\n- empty, OR\n- only greetings/thanks, OR\n- only preference setup, OR\n- pure nonsense / unreadable\n\nIf raw_topic is a clear request (like â€œremind me to call Ali tomorrow at 3 pmâ€),\nyou MUST NOT use fallback.\n\n====================================================================\nGRAMMAR RULE (CRITICAL)\n====================================================================\n\n- The first part MUST be a noun phrase that can follow the word â€œwithâ€.\n- The second part MUST be a question-style offer clause.\n- Join them with a comma or an em dash.\n- The whole output must read as ONE natural question after insertion.\n\nGOOD:\n- â€œyour call with Ali, want me to capture notes from that callâ€\n- â€œyour reminder to call Ali at 3 pm, want me to help you note the outcomeâ€\n\nBAD:\n- Multiple sentences\n- Anything ending with â€œ?â€\n- â€œeverything on your side, ...â€ when raw_topic is clear\n\n====================================================================\nSEGMENT B â€” CAPABILITY SELECTION (STRICT)\n====================================================================\n\nSTEP 1 â€” Detect capability already used by the user in raw_topic\n---------------------------------------------------\nREMINDER_USED if raw_topic includes:\n- â€œremind meâ€\n- â€œset a reminderâ€\n- â€œalarmâ€\n- â€œnotify meâ€\n- time scheduling like â€œtomorrow at 3 pmâ€, â€œat 5pmâ€, specific time\n\nCHECKLIST_USED if raw_topic includes:\n- â€œstepsâ€\n- â€œchecklistâ€\n- â€œSOPâ€\n- â€œprepareâ€\n- â€œwhat should I doâ€\n\nDRAFTING_USED if raw_topic includes:\n- â€œwriteâ€\n- â€œdraftâ€\n- â€œcaptionâ€\n- â€œpostâ€\n- â€œcontentâ€\n\nIf none apply, USED_CAPABILITY = NONE.\n\nSTEP 2 â€” Remove used capability from offer options\n---------------------------------------------------\nOffer options start as:\n- Reminder\n- Checklist\n- Drafting/Notes\n\nIf USED_CAPABILITY = REMINDER_USED â†’ remove Reminder\nIf USED_CAPABILITY = CHECKLIST_USED â†’ remove Checklist\nIf USED_CAPABILITY = DRAFTING_USED â†’ remove Drafting/Notes\n\nSTEP 3 â€” Choose ONE offer from remaining options\n---------------------------------------------------\nUse this priority order:\n1) Drafting/Notes (capture outcomes / notes / next steps)\n2) Checklist (prepare / agenda / quick plan)\n3) Reminder (only if not already used)\n\nIMPORTANT:\nIf the raw_topic is about a CALL or MEETING,\nprefer Drafting/Notes offer:\n- â€œwant me to capture notesâ€\n- â€œwant me to remember key pointsâ€\n- â€œwant me to help draft a follow-up messageâ€\n\nDO NOT offer the removed capability.\n\n====================================================================\nTIME RULE (UPDATED â€” CONDITIONAL)\n====================================================================\n\nIf raw_topic is a SCHEDULED ACTION (reminder/call/meeting with a future time),\nyou may keep the time reference (e.g., â€œtomorrow at 3 pmâ€) because it is a planned item.\n\nOnly apply â€œpast-styleâ€ conversions (that day / hari tu / waktu itu) for:\n- casual follow-ups about past events\n- chats where timing is not a scheduled reminder\n\n====================================================================\nCONSTRUCT THE OUTPUT (FINAL)\n====================================================================\n\nReturn ONLY the final question fragment string.\nNo extra text.\nNo explanations.\nNo punctuation at the end.\n"
            },
            {
              "content": "=raw_topic: {{ $json.context }}\ntarget_language: {{ $json.lang }}"
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        896,
        0
      ],
      "id": "b46314c7-f528-4b1c-8071-4219e97a1c0b",
      "name": "Localise Topic Phrase"
    },
    {
      "parameters": {
        "tableId": "conversations",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('Build WhatsApp Body').item.json.user_id }}"
            },
            {
              "fieldId": "telegram_chat_id",
              "fieldValue": "={{ $('Build WhatsApp Body').item.json.telegram_id }}"
            },
            {
              "fieldId": "message_id",
              "fieldValue": "={{ $json.sid }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "proactive_education"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now }}"
            },
            {
              "fieldId": "assistant_response",
              "fieldValue": "={{ $json.body }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2576,
        64
      ],
      "id": "2f97df23-15a7-48f2-b7e2-054b12e7449c",
      "name": "Update Conversation"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -256,
        0
      ],
      "id": "ef8b0d2d-8689-4c97-9b47-91929b14c030",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "users",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "is_active",
              "condition": "eq",
              "keyValue": "=true"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -896,
        256
      ],
      "id": "83eb8a39-63ae-4c9f-9899-87bbaff84f01",
      "name": "Get Users"
    },
    {
      "parameters": {
        "jsCode": "// Current item\nconst user = $json;\n\nconst raw = user.telegram_id || '';   // mixed: could be chat id or phone\nlet whatsappTo = null;\n\n// Simple heuristic: treat as phone if it looks like a Malaysian-style number\n// - starts with '+' or a digit\n// - length at least 10\nlet trimmed = String(raw).trim();\n\nif (trimmed) {\n  // If it's a pure Telegram chat ID like \"138220323\", this will also pass length,\n  // so we tighten it a bit: must start with '6' or '+6' for Malaysia.\n  const startsLikeMY = trimmed.startsWith('6') || trimmed.startsWith('+6');\n\n  if (startsLikeMY && trimmed.replace(/\\D/g, '').length >= 10) {\n    // Ensure it has a leading '+'\n    if (!trimmed.startsWith('+')) {\n      trimmed = `+${trimmed}`;\n    }\n    whatsappTo = `${trimmed}`;\n  }\n}\n\n// Return, adding whatsapp_to\nreturn {\n  json: {\n    ...user,\n    whatsapp_to: whatsappTo,\n  },\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1680,
        0
      ],
      "id": "5820c8d2-a8ed-475b-9ff9-f1464f6ea190",
      "name": "Prepare WhatsApp To"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b4a209d1-94e5-432b-a781-0589956dd9e8",
              "leftValue": "={{ !!$json.whatsapp_to }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1904,
        0
      ],
      "id": "a294a1fe-8366-4584-b778-2c3fab1b0ef3",
      "name": "If"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 9,
              "triggerAtMinute": 5
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -1120,
        208
      ],
      "id": "50f9e110-82a2-4232-bca6-667b8a6a1084",
      "name": "Triggers at 9.05 AM Daily"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.twilio.com/2010-04-01/Accounts/AC_REDACTED/Messages.json",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "twilioApi",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "From",
              "value": "whatsapp:+601125911400"
            },
            {
              "name": "To",
              "value": "={{ 'whatsapp:' + $json.whatsapp_to }}"
            },
            {
              "name": "ContentSid",
              "value": "={{ $json.content_sid }}"
            },
            {
              "name": "ContentVariables",
              "value": "={{ JSON.stringify({\n  \"1\": $json.name || \"there\",\n  \"2\": $json.localized_topic || \"everything on your side\"\n}) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2352,
        0
      ],
      "id": "0295ed3b-82ca-477e-b059-98b782f73881",
      "name": "Send Check-in Template"
    },
    {
      "parameters": {
        "jsCode": "// Current item from previous node\nconst item = $json;\n\n// Normalise language\nconst rawLang =\n  item.lang ||\n  item.preferred_language ||\n  'en';\n\nconst lang = String(rawLang).toLowerCase();\n\n// Map of language -> ContentSid\nconst templateMap = {\n  en: 'HX0d9770a9619045506dd36eba1317bd47', // English template SID\n  ms: 'HXeb549b04b1d93b8c2e1a7925d4fde95f', // Malay\n  id: 'HX268e41a69a48cbc23b4746920813ba2d', // Indonesian\n  zh: 'HX3269c5e2c441de177f1483a13bca8c7f', // Chinese (if you have)\n  ta: 'HX46552560c195b480643d03c5af5ce78c', // Tamil (if you have)\n};\n\n// Fallback: use English if we don't have a template for this lang\nconst defaultSid = templateMap.en;\nconst contentSid = templateMap[lang] || defaultSid;\n\nreturn {\n  json: {\n    ...item,\n    lang,          // normalised\n    content_sid: contentSid,\n  },\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2128,
        0
      ],
      "id": "d6a62973-abec-46b9-8a62-f07728470ce7",
      "name": "Choose Template SID"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "conversations",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "message_type",
              "condition": "eq",
              "keyValue": "proactive_education"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -896,
        64
      ],
      "id": "6662c035-4807-43e3-ac72-2d1bae7edc83",
      "name": "Get Segment B Educations"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Current item = one user\nconst user = $json;\nconst userId = user.user_id ?? user.id ?? null;\n\n// ğŸ”§ TEMP: force Segment B eligibility for testing\n//const FORCE_USER_IDS = new Set([\n//  \"2a4e5985-1b49-4cb6-bfc0-a85b296d8f30\", // Joe\n//]);\n\n\n\n// Helper: pick best display name\nfunction pickDisplayName(u) {\n  const candidates = [u.preferred_name, u.first_name, u.telegram_username];\n  for (const raw of candidates) {\n    if (raw === undefined || raw === null) continue;\n    const s = String(raw).trim();\n    if (!s) continue;\n    if (s.toLowerCase() === \"null\") continue;\n    return s;\n  }\n  return \"there\";\n}\n\nconst displayName = pickDisplayName(user);\n\n// 1) Calculate hours since last interaction\nlet hoursInactive = null;\nif (user.last_interaction) {\n  const lastInteraction = new Date(user.last_interaction);\n  hoursInactive = (Date.now() - lastInteraction.getTime()) / (1000 * 60 * 60);\n}\n\n// 2) Get ALL Segment B education rows (message_type = proactive_education)\nconst educationItems = $items(\"Get Segment B Educations\") || [];\n\n// Filter to only this user's Segment B education messages\nconst userEducations = educationItems\n  .map(i => i.json)\n  .filter(row => row.user_id === userId);\n\n// 3) Find latest Segment B education send time\nlet lastEducation = null;\nlet hoursSinceEducation = null;\n\nif (userEducations.length > 0) {\n  lastEducation = userEducations.reduce((latest, row) => {\n    if (!row.created_at) return latest;\n    const ts = new Date(row.created_at);\n    if (!latest || ts > latest) return ts;\n    return latest;\n  }, null);\n\n  if (lastEducation) {\n    hoursSinceEducation =\n      (Date.now() - lastEducation.getTime()) / (1000 * 60 * 60);\n  }\n}\n\n// 4) Determine eligibility for Segment B\nlet eligible = false;\n\n// Rule (Segment B):\n// - 24 < inactive <= 120 hours\n// - AND (no previous education OR last education >= 72 hours ago)\nif (hoursInactive !== null && hoursInactive > 24 && hoursInactive <= 120) {\n  if (hoursSinceEducation === null || hoursSinceEducation >= 72) {\n    eligible = true;\n  }\n}\n\n// ğŸ”§ TEMP override for testing\n//if (FORCE_USER_IDS.has(userId)) {\n//  eligible = true;\n//}\n\n\n\n\nreturn {\n  json: {\n    user_id: userId,\n\n    // Identity fields\n    name: displayName,\n    first_name: user.first_name ?? null,\n    preferred_name: user.preferred_name ?? null,\n    telegram_username: user.telegram_username ?? null,\n    preferred_language: user.preferred_language ?? null,\n    telegram_id: user.telegram_id ?? null,\n    whatsapp_id: user.whatsapp_id ?? null,\n\n    // Eligibility info\n    hoursInactive,\n    lastEducation: lastEducation ? lastEducation.toISOString() : null,\n    hoursSinceEducation,\n    eligible_for_segment_b: eligible,\n  },\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -672,
        208
      ],
      "id": "8745f163-cbea-45be-8692-a471caa2bae0",
      "name": "Compute Segment B Eligibility"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d2f817e3-a74e-467f-bcf4-3ad961cda816",
              "leftValue": "={{ $json.eligible_for_segment_b }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -448,
        208
      ],
      "id": "7a3c604a-d47b-4408-bd72-86ea7f8ac5a1",
      "name": "IF Eligible For Segment B"
    },
    {
      "parameters": {
        "jsCode": "// Time Normaliser (en/ms/id/zh/ta quick rules)\n// Goal: remove future framing + remove exact time fragments that sound like future scheduling\n// Input: base.localized_topic OR OpenAI output text\n// Output: base.localized_topic normalized\n\nconst base = $json;\n\n// 1) get candidate localized topic\nlet topic = (base.localized_topic || '').toString().trim();\n\nif (!topic) {\n  const t = $node[\"Localise Topic Phrase\"]?.json?.output?.[0]?.content?.[0]?.text;\n  if (typeof t === \"string\") topic = t.trim();\n}\n\nif (!topic) return [{ json: { ...base, localized_topic: \"\" } }];\n\nconst lang = (base.lang || \"en\").toString().toLowerCase();\n\nconst tidy = (s) => s.replace(/\\s+/g, \" \").trim();\n\n// ---- helpers to remove time fragments (EN) ----\nfunction stripExactTimeEN(s) {\n  // remove \"at 11 am\", \"at 10:30am\", \"at 11:00 PM\", \"at 3pm\"\n  s = s.replace(/\\bat\\s+\\d{1,2}(:\\d{2})?\\s*(am|pm)\\b/gi, \"\");\n  // remove standalone times like \"10:30am\", \"11 am\"\n  s = s.replace(/\\b\\d{1,2}(:\\d{2})?\\s*(am|pm)\\b/gi, \"\");\n  return tidy(s);\n}\n\nfunction stripExactTimeMS(s) {\n  // \"pukul 10.30\", \"pukul 10:30\", \"jam 10.30\"\n  s = s.replace(/\\b(pukul|jam)\\s+\\d{1,2}([.:]\\d{2})?\\b/gi, \"\");\n  return tidy(s);\n}\n\nfunction stripExactTimeID(s) {\n  // \"jam 10.30\", \"pukul 10.30\"\n  s = s.replace(/\\b(jam|pukul)\\s+\\d{1,2}([.:]\\d{2})?\\b/gi, \"\");\n  return tidy(s);\n}\n\n// 2) normalise future words -> past/neutral + strip time\nif (lang === \"en\") {\n  const hadFuture =\n    /\\btomorrow\\b/i.test(topic) ||\n    /\\btoday\\b/i.test(topic) ||\n    /\\btonight\\b/i.test(topic) ||\n    /\\bthis evening\\b/i.test(topic) ||\n    /\\blater\\b/i.test(topic) ||\n    /\\bin\\s+\\d+\\s+(minutes?|hours?)\\b/i.test(topic);\n\n  topic = topic\n    .replace(/\\btomorrow\\b/gi, \"that day\")\n    .replace(/\\btoday\\b/gi, \"that day\")\n    .replace(/\\btonight\\b/gi, \"that night\")\n    .replace(/\\bthis evening\\b/gi, \"that evening\")\n    .replace(/\\blater\\b/gi, \"earlier\")\n    .replace(/\\bin\\s+\\d+\\s+(minutes?|hours?)\\b/gi, \"earlier\");\n\n  // If it previously had future framing, remove exact time fragments (less awkward)\n  if (hadFuture) topic = stripExactTimeEN(topic);\n}\n\nif (lang === \"ms\") {\n  const hadFuture =\n    /\\besok\\b/i.test(topic) ||\n    /\\bhari ini\\b/i.test(topic) ||\n    /\\bmalam ini\\b/i.test(topic) ||\n    /\\bnanti\\b/i.test(topic) ||\n    /\\blepas\\s+\\d+\\s+minit\\b/i.test(topic);\n\n  topic = topic\n    .replace(/\\besok\\b/gi, \"hari tu\")\n    .replace(/\\bhari ini\\b/gi, \"hari tu\")\n    .replace(/\\bmalam ini\\b/gi, \"malam tu\")\n    .replace(/\\bnanti\\b/gi, \"masa tu\")\n    .replace(/\\blepas\\s+\\d+\\s+minit\\b/gi, \"masa tu\");\n\n  if (hadFuture) topic = stripExactTimeMS(topic);\n}\n\nif (lang === \"id\") {\n  const hadFuture =\n    /\\bbesok\\b/i.test(topic) ||\n    /\\bhari ini\\b/i.test(topic) ||\n    /\\bmalam ini\\b/i.test(topic) ||\n    /\\bnanti\\b/i.test(topic) ||\n    /\\bdalam\\s+\\d+\\s+(menit|jam)\\b/i.test(topic);\n\n  topic = topic\n    .replace(/\\bbesok\\b/gi, \"waktu itu\")\n    .replace(/\\bhari ini\\b/gi, \"waktu itu\")\n    .replace(/\\bmalam ini\\b/gi, \"malam itu\")\n    .replace(/\\bnanti\\b/gi, \"waktu itu\")\n    .replace(/\\bdalam\\s+\\d+\\s+(menit|jam)\\b/gi, \"waktu itu\");\n\n  if (hadFuture) topic = stripExactTimeID(topic);\n}\n\n// final cleanup: remove double commas/spaces after stripping time\ntopic = tidy(\n  topic\n    .replace(/\\s+,/g, \",\")\n    .replace(/,\\s*,/g, \",\")\n    .replace(/\\s+-\\s+/g, \" \")\n);\n\n// patch OpenAI output text too (prevents fallback leaks)\nif (base.output?.[0]?.content?.[0]?.text) {\n  base.output[0].content[0].text = topic;\n}\n\nreturn [{ json: { ...base, localized_topic: topic } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1248,
        0
      ],
      "id": "7f176ffd-2303-40d4-811f-770a01c4d2c5",
      "name": "Time Normaliser"
    }
  ],
  "connections": {
    "Prepare Template Payload": {
      "main": [
        [
          {
            "node": "Get Last Topic Row",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Last Topic Row": {
      "main": [
        [
          {
            "node": "Extract Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Context": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Localise Topic Phrase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build WhatsApp Body": {
      "main": [
        [
          {
            "node": "Prepare WhatsApp To",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Localise Topic Phrase": {
      "main": [
        [
          {
            "node": "Time Normaliser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Prepare Template Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Conversation": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Users": {
      "main": [
        [
          {
            "node": "Compute Segment B Eligibility",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare WhatsApp To": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Choose Template SID",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Triggers at 9.05 AM Daily": {
      "main": [
        [
          {
            "node": "Get Segment B Educations",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Choose Template SID": {
      "main": [
        [
          {
            "node": "Send Check-in Template",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Check-in Template": {
      "main": [
        [
          {
            "node": "Update Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Segment B Educations": {
      "main": [
        [
          {
            "node": "Compute Segment B Eligibility",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compute Segment B Eligibility": {
      "main": [
        [
          {
            "node": "IF Eligible For Segment B",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Eligible For Segment B": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Time Normaliser": {
      "main": [
        [
          {
            "node": "Build WhatsApp Body",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": {
    "node:Triggers at 9.05 AM Daily": {
      "recurrenceRules": []
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true
  }
}
